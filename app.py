import streamlit as st
from oauth2client.service_account import ServiceAccountCredentials
import gspread

# ---------- GOOGLE SHEETS CONNECTION ----------
SCOPE = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
service_account_info = st.secrets["google_service_account"]
CREDS = ServiceAccountCredentials.from_json_keyfile_dict(service_account_info, SCOPE)
CLIENT = gspread.authorize(CREDS)
SHEET_NAME = "symptom_records"
sheet = CLIENT.open(SHEET_NAME).sheet1

# ---------- APP TITLE ----------
st.set_page_config(page_title="рд▓рдХреНрд╖рдг-рдЖрдзрд╛рд░рд┐рдд рд░реЛрдЧ рдЬрд╛рдБрдЪ", page_icon="ЁЯзк", layout="wide")
st.title("ЁЯза рд▓рдХреНрд╖рдг-рдЖрдзрд╛рд░рд┐рдд рд░реЛрдЧ рдЬрд╛рдБрдЪ")
st.write("рд▓рдХреНрд╖рдг рдЪреБрдиреЗрдВ рдФрд░ рд╕рдВрднрд╛рд╡рд┐рдд рд░реЛрдЧ/рд╣реГрджрдп рдпрд╛ рдХреИрдВрд╕рд░ рдЬреЛрдЦрд┐рдо рджреЗрдЦреЗрдВред рдЖрдпреБ рдФрд░ рд▓рдХреНрд╖рдгреЛрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЬреЛрдЦрд┐рдо рд╕реНрдХреЛрд░ рдЕрдиреБрдорд╛рдирд┐рддред")

# ---------- USER DETAILS FORM ----------
with st.form("user_form"):
    col1, col2 = st.columns(2)
    with col1:
        name = st.text_input("ЁЯСд рдкреВрд░рд╛ рдирд╛рдо")
        age = st.number_input("ЁЯОВ рдЙрдореНрд░", min_value=0, max_value=120, step=1)
        gender = st.radio("тЪз рд▓рд┐рдВрдЧ", ["рдкреБрд░реБрд╖", "рдорд╣рд┐рд▓рд╛"])
        mobile = st.text_input("ЁЯУ▒ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░")
    with col2:
        st.subheader("ЁЯй║ рдореЗрдбрд┐рдХрд▓ рдЗрддрд┐рд╣рд╛рд╕")
        bp = st.checkbox("рдЙрдЪреНрдЪ рд░рдХреНрддрдЪрд╛рдк")
        diabetes = st.checkbox("рдбрд╛рдпрдмрд┐рдЯреАрдЬрд╝")
        heart = st.checkbox("рд╣реГрджрдп рд╕рдорд╕реНрдпрд╛")
        location = st.text_input("ЁЯУН рд╕реНрдерд╛рди / рд╢рд╣рд░")

    st.subheader("ЁЯзН рд▓рдХреНрд╖рдг рдЪреБрдиреЗрдВ")

    # ---------- SYMPTOM LISTS ----------
    basic_symptoms = [
        "рдмреБрдЦрд╛рд░", "рдХрд╛рдБрдкрдирд╛", "рдХрдордЬрд╝реЛрд░реА / рдердХрд╛рди", "рд╕рд┐рд░рджрд░реНрдж", "рдорддрд▓реА / рдЙрд▓реНрдЯреА", "рдорд╛рдВрд╕рдкреЗрд╢реА / рдЬреЛрдбрд╝реЛрдВ рдореЗрдВ рджрд░реНрдж"
    ]

    advanced_symptoms = [
        "рджрд╕реНрдд", "рдкреЗрдЯ рдореЗрдВ рджрд░реНрдж", "рднреВрдЦ рдХреА рдХрдореА", "рд░реИрд╢", "рдЦрд╛рдВрд╕реА",
        "рдЖрдВрдЦ рдХреЗ рдкреАрдЫреЗ рджрд░реНрдж", "рд╕реВрдЬреА рд╣реБрдИ рдЧреНрд░рдВрдерд┐рдпрд╛рдБ", "рдкреАрд▓рд╛рдкрди (рддреНрд╡рдЪрд╛/рдЖрдБрдЦ)", "рдХрдордЬрд╝реЛрд░реА"
    ]

    heart_symptoms = [
        "рд╕реАрдиреЗ рдореЗрдВ рджрд░реНрдж / рджрдмрд╛рд╡", "рдмрд╛рдВрд╣ / рдЬрдмрдбрд╝рд╛ / рдкреАрда / рдЧрд░реНрджрди / рдЧрд▓рд╛ рдореЗрдВ рджрд░реНрдж",
        "рд╕рд╛рдБрд╕ рд▓реЗрдиреЗ рдореЗрдВ рддрдХрд▓реАрдлрд╝", "рддреЗрдЬрд╝ / рдЕрдирд┐рдпрдорд┐рдд рд╣реГрджрдп рдЧрддрд┐", "рдкреИрд░ / рдЯрдЦрдиреЗ / рдкреИрд░реЛрдВ рдореЗрдВ рд╕реВрдЬрди",
        "рд╡реНрдпрд╛рдпрд╛рдо рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдореЗрдВ рдХрдореА", "рдШреЛрдВрдШрд╛ / рд▓рдЧрд╛рддрд╛рд░ рдЦрд╛рдВрд╕реА", "рдкреЗрдЯ рдореЗрдВ рд╕реВрдЬрди",
        "рддреЗрдЬрд╝ рд╡рдЬрди рдмрдврд╝рдирд╛", "рдорддрд▓реА / рднреВрдЦ рдХреА рдХрдореА", "рдПрдХрд╛рдЧреНрд░рддрд╛ рдХреА рдХрдореА", "рдЪрдХреНрдХрд░ / рдмреЗрд╣реЛрд╢реА", "рдардВрдбреА рдкрд╕реАрдиреЗ"
    ]

    # Male Cancer Symptoms
    male_cancer_symptoms = [
        "рдкреНрд░реЛрд╕реНрдЯреЗрдЯ рд╕рдорд╕реНрдпрд╛ (рдмрд╛рд░-рдмрд╛рд░ рдкреЗрд╢рд╛рдм, рдХрдордЬреЛрд░ рдзрд╛рд░рд╛, рд╢реНрд░реЛрдгрд┐ рдореЗрдВ рджрд░реНрдж)",
        "рдЕрдВрдбрдХреЛрд╖ рдореЗрдВ рдЧрд╛рдВрда / рд╕реВрдЬрди",
        "рд░рдХреНрдд рдореЗрдВ рдЕрд╕рд╛рдорд╛рдиреНрдпрддрд╛рдПрдБ / рдЪреЛрдЯ рдпрд╛ рдЦреВрди рдХрд╛ рдмрд╣рдирд╛",
        "рджрд░реНрдж рдЬреЛ рдирд╣реАрдВ рдЬрд╛рддрд╛",
        "рдореБрдБрд╣ рдореЗрдВ рдШрд╛рд╡ / рд░рдХреНрддрд╕реНрд░рд╛рд╡ / рд╕реБрдиреНрдирддрд╛",
        "рд▓рдЧрд╛рддрд╛рд░ рдЦрд╛рдВрд╕реА / рд╕реНрд╡рд░ рдмрджрд▓рд╛рд╡",
        "рдЕрдирдЬрд╛рдиреА рд╡рдЬрди рдХрдореА / рд╡реГрджреНрдзрд┐",
        "рд╕рд╛рдВрдп / рдЧрд╛рдВрдареЗрдВ",
        "рддреНрд╡рдЪрд╛ рдореЗрдВ рдмрджрд▓рд╛рд╡ / рдкреАрд▓рд╛рдкрди / рдирдИ рдореЛрд▓",
        "рд╕рд┐рд░рджрд░реНрдж / рджреМрд░реЗ",
        "рдЕрддреНрдпрдзрд┐рдХ рдердХрд╛рди / рдХрдордЬреЛрд░реА",
        "рджреГрд╖реНрдЯрд┐ рдпрд╛ рд╕реБрдирдиреЗ рдХреА рд╕рдорд╕реНрдпрд╛рдПрдВ"
    ]

    # Female Cancer Symptoms
    female_cancer_symptoms = male_cancer_symptoms + [
        "рд╕реНрддрди рдореЗрдВ рдЧрд╛рдВрда / рдореЛрдЯрд╛рдИ",
        "рдЕрд╕рд╛рдорд╛рдиреНрдп рд╕реНрддрди рд╕реНрддреНрд░рд╛рд╡",
        "рд╢реНрд░реЛрдгрд┐ рдореЗрдВ рджрд░реНрдж / рд╕реВрдЬрди",
        "рдЕрд╕рд╛рдорд╛рдиреНрдп рдпреЛрдирд┐ рд░рдХреНрддрд╕реНрд░рд╛рд╡",
        "рдЕрдВрдбрд╛рд╢рдп рдпрд╛ рдЧрд░реНрднрд╛рд╢рдп рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рджрд░реНрдж / рд╕реВрдЬрди"
    ]

    # ---------- USER INPUT ----------
    selected_basic = st.multiselect("рдореВрд▓ рд▓рдХреНрд╖рдг", basic_symptoms)
    selected_advanced = st.multiselect("рдЙрдиреНрдирдд рд▓рдХреНрд╖рдг", advanced_symptoms)
    if gender == "рдкреБрд░реБрд╖":
        selected_cancer = st.multiselect("рдкреБрд░реБрд╖ рдХреИрдВрд╕рд░ рд▓рдХреНрд╖рдг", male_cancer_symptoms)
    else:
        selected_cancer = st.multiselect("рдорд╣рд┐рд▓рд╛ рдХреИрдВрд╕рд░ рд▓рдХреНрд╖рдг", female_cancer_symptoms)
    selected_heart = st.multiselect("рд╣реГрджрдп / рдХрд╛рд░реНрдбрд┐рдпреЛрд╡рд╕реНрдХреБрд▓рд░ рд▓рдХреНрд╖рдг", heart_symptoms)

    submitted = st.form_submit_button("ЁЯФН рдЬрд╛рдБрдЪ рдХрд░реЗрдВ")

# ---------- DIAGNOSIS LOGIC ----------
def diagnose(basic, advanced, cancer, heart, age):
    possible = []
    organs = []
    risk_score = 0

    all_symptoms = basic + advanced + cancer + heart
    symptom_count = len(all_symptoms)

    # ---------- Viral / Fever / Bacterial ----------
    if "рдмреБрдЦрд╛рд░" in basic:
        if any(s in advanced for s in ["рджрд╕реНрдд", "рд░реИрд╢", "рдЖрдВрдЦ рдХреЗ рдкреАрдЫреЗ рджрд░реНрдж"]):
            if "рд░реИрд╢" in advanced or "рдЖрдВрдЦ рдХреЗ рдкреАрдЫреЗ рджрд░реНрдж" in advanced:
                possible.append("рдбреЗрдВрдЧреВ / рд╡рд╛рдпрд░рд▓ рд╕рдВрдХреНрд░рдордг")
                organs.append("рд░рдХреНрдд / рдкреНрд░рддрд┐рд░рдХреНрд╖рд╛ рдкреНрд░рдгрд╛рд▓реА")
            elif "рджрд╕реНрдд" in advanced:
                possible.append("рдЯрд╛рдЗрдлрд╛рдЗрдб / рдмреИрдХреНрдЯреАрд░рд┐рдпрд▓ рд╕рдВрдХреНрд░рдордг")
                organs.append("рдкрд╛рдЪрди рддрдВрддреНрд░")
            else:
                possible.append("рд╡рд╛рдпрд░рд▓ рдмреБрдЦрд╛рд░")
                organs.append("рдкреНрд░рддрд┐рд░рдХреНрд╖рд╛ рдкреНрд░рдгрд╛рд▓реА")

    # ---------- Malaria ----------
    if "рдХрдордЬрд╝реЛрд░реА / рдердХрд╛рди" in basic and "рджрд╕реНрдд" in advanced and "рдкреЗрдЯ рдореЗрдВ рджрд░реНрдж" in advanced:
        possible.append("рдорд▓реЗрд░рд┐рдпрд╛")
        organs.append("рд░рдХреНрдд / рдЬрд┐рдЧрд░ / рдЬреЛрдбрд╝")

    # ---------- Cancer ----------
    if cancer:
        possible.append("рд╕рдВрднрд╛рд╡рд┐рдд рдХреИрдВрд╕рд░")
        organs.append("рд▓рдХреНрд╖рдгреЛрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдкреНрд░рднрд╛рд╡рд┐рдд рдЕрдВрдЧ")

    # ---------- Heart Issues ----------
    if heart:
        possible.append("рд╣реГрджрдп / рдХрд╛рд░реНрдбрд┐рдпреЛрд╡рд╕реНрдХреБрд▓рд░ рдЬреЛрдЦрд┐рдо")
        organs.append("рд╣реГрджрдп / рдкрд░рд┐рд╕рдВрдЪрд░рдг рдкреНрд░рдгрд╛рд▓реА")

    # ---------- Risk Score ----------
    risk_score = min(100, symptom_count * 5 + (age / 2))

    return possible, organs, risk_score

# ---------- SHOW RESULTS ----------
if submitted:
    if not name or not mobile:
        st.error("рдХреГрдкрдпрд╛ рдЕрдкрдирд╛ рдирд╛рдо рдФрд░ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ рджрд░реНрдЬ рдХрд░реЗрдВред")
    else:
        results, organs, risk = diagnose(selected_basic, selected_advanced, selected_cancer, selected_heart, age)
        if results:
            st.success(f"**рд╕рдВрднрд╛рд╡рд┐рдд рд░реЛрдЧ / рд╕реНрдерд┐рддрд┐:**")
            for r, o in zip(results, organs):
                st.write(f"ЁЯФ╕ {r} тЖТ рд╕рдВрднрд╛рд╡рд┐рдд рдЕрдВрдЧ/рдкреНрд░рдгрд╛рд▓реА: {o}")
            st.info(f"**рдЕрдиреБрдорд╛рдирд┐рдд рдЬреЛрдЦрд┐рдо рд╕реНрдХреЛрд░:** {risk:.1f}%")
        else:
            st.info("рдЪрдпрдирд┐рдд рд▓рдХреНрд╖рдгреЛрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдХреЛрдИ рдЧрдВрднреАрд░ рд░реЛрдЧ рд╕рдВрдХреЗрдд рдирд╣реАрдВ рдорд┐рд▓рд╛ред")

        # ---------- SAVE DATA TO GOOGLE SHEET ----------
        data = [
            name, age, gender, mobile, bp, diabetes, heart, location,
            ", ".join(selected_basic + selected_advanced + selected_cancer + selected_heart),
            ", ".join(results), ", ".join(organs), f"{risk:.1f}%"
        ]
        sheet.append_row(data)
        st.success("тЬЕ рдЖрдкрдХреА рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рд░рд┐рдХреЙрд░реНрдб рдХрд░ рджреА рдЧрдИ рд╣реИред")

# ---------- FOOTER ----------
st.markdown("---")
st.caption("тЪая╕П рдпрд╣ рдЙрдкрдХрд░рдг рдХреЗрд╡рд▓ рд╢реИрдХреНрд╖рд┐рдХ / рдбреЗрдореЛ рдкреНрд░рдпреЛрдЬрдиреЛрдВ рдХреЗ рд▓рд┐рдП рд╣реИред рдпрд╣ рдкреЗрд╢реЗрд╡рд░ рдЪрд┐рдХрд┐рддреНрд╕рд╛ рд╕рд▓рд╛рд╣ рдХрд╛ рд╡рд┐рдХрд▓реНрдк рдирд╣реАрдВ рд╣реИред")
