import streamlit as st
from oauth2client.service_account import ServiceAccountCredentials
import gspread

# ---------- GOOGLE SHEETS CONNECTION ----------
SCOPE = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
service_account_info = st.secrets["google_service_account"]
CREDS = ServiceAccountCredentials.from_json_keyfile_dict(service_account_info, SCOPE)
CLIENT = gspread.authorize(CREDS)
SHEET_NAME = "symptom_records"
sheet = CLIENT.open(SHEET_NAME).sheet1

# ---------- APP TITLE ----------
st.set_page_config(page_title="рд▓рдХреНрд╖рдг-рдЖрдзрд╛рд░рд┐рдд рд░реЛрдЧ рдЬрд╛рдВрдЪ", page_icon="ЁЯзк", layout="wide")
st.title("ЁЯза рд▓рдХреНрд╖рдг-рдЖрдзрд╛рд░рд┐рдд рд░реЛрдЧ рдЬрд╛рдВрдЪ")
st.write("рд▓рдХреНрд╖рдг рдЪреБрдиреЗрдВ рдФрд░ рд╕рдВрднрд╛рд╡рд┐рдд рд░реЛрдЧ рдЬреЛрдЦрд┐рдо рджреЗрдЦреЗрдВред рдЬреЛрдЦрд┐рдо рд╕реНрдХреЛрд░ рдЙрдореНрд░ рдФрд░ рд▓рдХреНрд╖рдгреЛрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдЕрдиреБрдорд╛рдирд┐рдд рд╣реИред")

# ---------- USER DETAILS FORM ----------
with st.form("user_form"):
    col1, col2 = st.columns(2)
    with col1:
        name = st.text_input("ЁЯСд рдкреВрд░рд╛ рдирд╛рдо")
        age = st.number_input("ЁЯОВ рдЙрдореНрд░", min_value=0, max_value=120, step=1)
        gender = st.radio("тЪз рд▓рд┐рдВрдЧ", ["рдкреБрд░реБрд╖", "рдорд╣рд┐рд▓рд╛"])
        mobile = st.text_input("ЁЯУ▒ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░")
    with col2:
        st.subheader("ЁЯй║ рдЪрд┐рдХрд┐рддреНрд╕реАрдп рдЗрддрд┐рд╣рд╛рд╕")
        bp = st.checkbox("рдЙрдЪреНрдЪ рд░рдХреНрддрдЪрд╛рдк")
        diabetes = st.checkbox("рдордзреБрдореЗрд╣")
        heart = st.checkbox("рд╣реГрджрдп рд╕рдВрдмрдВрдзреА рд╕рдорд╕реНрдпрд╛")
        location = st.text_input("ЁЯУН рд╕реНрдерд╛рди / рд╢рд╣рд░")

    st.subheader("ЁЯзН рд▓рдХреНрд╖рдг рдЪреБрдиреЗрдВ")

    # ---------- SYMPTOM LISTS IN HINDI ----------
    basic_symptoms = [
        "рдмреБрдЦрд╛рд░", "рд╕рд░реНрджреА / рдХрдВрдкрдХрдВрдкреА", "рдердХрд╛рди / рдХрдордЬреЛрд░реА", "рд╕рд┐рд░рджрд░реНрдж", "рдорддрд▓реА / рдЙрд▓реНрдЯреА", "рдорд╛рдВрд╕рдкреЗрд╢рд┐рдпреЛрдВ / рдЬреЛрдбрд╝реЛрдВ рдореЗрдВ рджрд░реНрдж"
    ]

    advanced_symptoms = [
        "рджрд╕реНрдд", "рдкреЗрдЯ рдореЗрдВ рджрд░реНрдж", "рднреВрдЦ рди рд▓рдЧрдирд╛", "рдЪрдХрддреНрддреЗрджрд╛рд░ рджрд╛рдиреЗ / рд░реИрд╢", "рдЦрд╛рдВрд╕реА",
        "рдЖрдВрдЦреЛрдВ рдХреЗ рдкреАрдЫреЗ рджрд░реНрдж", "рд╕реБрдИ рдЬреИрд╕реЗ рджрд╛рдиреЗ", "рдкреАрд▓реА рддреНрд╡рдЪрд╛ / рдЖрдВрдЦреЗрдВ", "рдХрдордЬреЛрд░реА"
    ]

    heart_symptoms = [
        "рд╕реАрдиреЗ рдореЗрдВ рджрд░реНрдж / рджрдмрд╛рд╡", "рдмрд╛рдВрд╣ / рдЬрдмрдбрд╝рд╛ / рдкреАрда / рдЧрд░реНрджрди / рдЧрд▓рд╛ рдореЗрдВ рджрд░реНрдж", 
        "рд╕рд╛рдВрд╕ рд▓реЗрдиреЗ рдореЗрдВ рдХрдард┐рдирд╛рдИ", "рддреЗрдЬрд╝ / рдЕрдирд┐рдпрдорд┐рдд рдзрдбрд╝рдХрди", "рдкреИрд░ / рдЯрдЦрдиреЗ / рдкрд╛рдВрд╡ рдореЗрдВ рд╕реВрдЬрди",
        "рд╡реНрдпрд╛рдпрд╛рдо рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдХрдо рд╣реЛрдирд╛", "рд╕рд╛рдБрд╕ рдореЗрдВ рдЦрд░рд╛рд╢ / рд▓рдЧрд╛рддрд╛рд░ рдЦрд╛рдВрд╕реА", 
        "рдкреЗрдЯ рдореЗрдВ рд╕реВрдЬрди", "рддреЗрдЬрд╝ рд╡рдЬрди рдмрдврд╝рдирд╛", "рдорддрд▓реА / рднреВрдЦ рди рд▓рдЧрдирд╛", 
        "рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд░рдиреЗ рдореЗрдВ рдХрдард┐рдирд╛рдИ", "рдЪрдХреНрдХрд░ / рдмреЗрд╣реЛрд╢реА", "рдардВрдбреА рдкрд╕реАрдирд╛"
    ]

    cancer_symptoms = [
        "рд╕реНрддрди рдореЗрдВ рдЧрд╛рдВрда / рдореЛрдЯрд╛рдИ", "рдЕрд╕рд╛рдорд╛рдиреНрдп рд╕реНрддрди рд╕реНрддрдирдкрд╛рди рд╕реЗ рд╕реНрддреНрд░рд╛рд╡", 
        "рд╢реНрд░реЛрдгрд┐ рдореЗрдВ рджрд░реНрдж / рд╕реВрдЬрди", "рдкреЗрдЯ рдореЗрдВ рджрд░реНрдж / рд╕реВрдЬрди", "рдкреНрд░реЛрд╕реНрдЯреЗрдЯ рд╕рдорд╕реНрдпрд╛", "рдЕрдВрдбрдХреЛрд╖ рдореЗрдВ рдЧрд╛рдВрда / рд╕реВрдЬрди",
        "рдЕрд╕рд╛рдорд╛рдиреНрдп рд░рдХреНрддрд╕реНрд░рд╛рд╡ / рдЪреЛрдЯ", "рдЬрд┐рдирдореЗрдВ рджрд░реНрдж рдирд╣реАрдВ рдЬрд╛рддрд╛", "рдореБрдБрд╣ рдореЗрдВ рдШрд╛рд╡ / рд░рдХреНрддрд╕реНрд░рд╛рд╡ / рд╕реБрдиреНрдирддрд╛",
        "рд▓рдЧрд╛рддрд╛рд░ рдЦрд╛рдВрд╕реА / рд╕реНрд╡рд░ рдмрджрд▓рд╛рд╡", "рдЕрдирдЬрд╛рдиреА рд╡рдЬрди рдХрдореА / рд╡реГрджреНрдзрд┐", "рд╕рд╛рдВрдп / рдЧрд╛рдВрдареЗрдВ",
        "рддреНрд╡рдЪрд╛ рдореЗрдВ рдмрджрд▓рд╛рд╡ / рдкреАрд▓рд╛рдкрди / рдирдИ рдореЛрд▓", "рд╕рд┐рд░рджрд░реНрдж / рджреМрд░реЗ", "рдЕрддреНрдпрдзрд┐рдХ рдердХрд╛рди / рдХрдордЬреЛрд░реА",
        "рджреГрд╖реНрдЯрд┐ рдпрд╛ рд╕реБрдирдиреЗ рдХреА рд╕рдорд╕реНрдпрд╛рдПрдВ"
    ]

    # ---------- USER INPUT ----------
    selected_basic = st.multiselect("рдмреБрдирд┐рдпрд╛рджреА рд▓рдХреНрд╖рдг", basic_symptoms)
    selected_advanced = st.multiselect("рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рд▓рдХреНрд╖рдг", advanced_symptoms)
    if gender == "рдкреБрд░реБрд╖":
        selected_cancer = st.multiselect("рдкреБрд░реБрд╖ рдХреИрдВрд╕рд░ рд▓рдХреНрд╖рдг", cancer_symptoms)
    else:
        selected_cancer = st.multiselect("рдорд╣рд┐рд▓рд╛ рдХреИрдВрд╕рд░ рд▓рдХреНрд╖рдг", cancer_symptoms)
    selected_heart = st.multiselect("рд╣реГрджрдп / рдХрд╛рд░реНрдбрд┐рдпреЛрд╡рд╕реНрдХреБрд▓рд░ рд▓рдХреНрд╖рдг", heart_symptoms)

    submitted = st.form_submit_button("ЁЯФН рдЬрд╛рдБрдЪ рдХрд░реЗрдВ")

# ---------- DIAGNOSIS LOGIC ----------
def diagnose(basic, advanced, cancer, heart, age):
    possible = []
    organs = []
    risk_score = 0

    all_symptoms = basic + advanced + cancer + heart
    symptom_count = len(all_symptoms)

    # ---------- Viral / Fever / Bacterial ----------
    if "рдмреБрдЦрд╛рд░" in basic:
        if any(s in advanced for s in ["рджрд╕реНрдд", "рдЪрдХрддреНрддреЗрджрд╛рд░ рджрд╛рдиреЗ / рд░реИрд╢", "рдЖрдВрдЦреЛрдВ рдХреЗ рдкреАрдЫреЗ рджрд░реНрдж"]):
            if "рдЪрдХрддреНрддреЗрджрд╛рд░ рджрд╛рдиреЗ / рд░реИрд╢" in advanced or "рдЖрдВрдЦреЛрдВ рдХреЗ рдкреАрдЫреЗ рджрд░реНрдж" in advanced:
                possible.append("рдбреЗрдВрдЧреВ / рд╡рд╛рдпрд░рд▓ рд╕рдВрдХреНрд░рдордг")
                organs.append("рд░рдХреНрдд / рдкреНрд░рддрд┐рд░рдХреНрд╖рд╛ рдкреНрд░рдгрд╛рд▓реА")
            elif "рджрд╕реНрдд" in advanced:
                possible.append("рдЯрд╛рдпрдлреЙрдЗрдб / рдмреИрдХреНрдЯреАрд░рд┐рдпрд▓ рд╕рдВрдХреНрд░рдордг")
                organs.append("рдкрд╛рдЪрди рддрдВрддреНрд░")
            else:
                possible.append("рд╡рд╛рдпрд░рд▓ рдмреБрдЦрд╛рд░")
                organs.append("рдкреНрд░рддрд┐рд░рдХреНрд╖рд╛ рдкреНрд░рдгрд╛рд▓реА")

    # ---------- Malaria ----------
    if "рдердХрд╛рди / рдХрдордЬреЛрд░реА" in basic and "рджрд╕реНрдд" in advanced and "рдкреЗрдЯ рдореЗрдВ рджрд░реНрдж" in advanced:
        possible.append("рдорд▓реЗрд░рд┐рдпрд╛")
        organs.append("рд░рдХреНрдд / рдЬрд┐рдЧрд░ / рдЬреЛреЬ")

    # ---------- Cancer ----------
    if cancer:
        possible.append("рд╕рдВрднрд╛рд╡рд┐рдд рдХреИрдВрд╕рд░")
        organs.append("рд▓рдХреНрд╖рдгреЛрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдкреНрд░рднрд╛рд╡рд┐рдд рдЕрдВрдЧ")

    # ---------- Heart Issues ----------
    if heart:
        possible.append("рд╣реГрджрдп / рдХрд╛рд░реНрдбрд┐рдпреЛрд╡рд╕реНрдХреБрд▓рд░ рдЬреЛрдЦрд┐рдо")
        organs.append("рд╣реГрджрдп / рдкрд░рд┐рд╕рдВрдЪрд░рдг рдкреНрд░рдгрд╛рд▓реА")

    # ---------- Risk Score ----------
    risk_score = min(100, symptom_count * 5 + (age / 2))
    
    return possible, organs, risk_score

# ---------- SHOW RESULTS ----------
if submitted:
    if not name or not mobile:
        st.error("рдХреГрдкрдпрд╛ рдЕрдкрдирд╛ рдирд╛рдо рдФрд░ рдореЛрдмрд╛рдЗрд▓ рдирдВрдмрд░ рджрд░реНрдЬ рдХрд░реЗрдВред")
    else:
        results, organs, risk = diagnose(selected_basic, selected_advanced, selected_cancer, selected_heart, age)
        if results:
            st.success(f"**рд╕рдВрднрд╛рд╡рд┐рдд рд╕реНрдерд┐рддрд┐рдпрд╛рдБ:**")
            for r, o in zip(results, organs):
                st.write(f"ЁЯФ╕ {r} тЖТ рд╕рдВрднрд╛рд╡рд┐рдд рдЕрдВрдЧ / рдкреНрд░рдгрд╛рд▓реА: {o}")
            st.info(f"**рдЕрдиреБрдорд╛рдирд┐рдд рдЬреЛрдЦрд┐рдо рд╕реНрдХреЛрд░:** {risk:.1f}%")
        else:
            st.info("рдЪрдпрдирд┐рдд рд▓рдХреНрд╖рдгреЛрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдХреЛрдИ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд░реЛрдЧ рд╕рдВрдХреЗрдд рдирд╣реАрдВ рдорд┐рд▓рд╛ред")

        # ---------- SAVE DATA TO GOOGLE SHEET ----------
        data = [
            name, age, gender, mobile, bp, diabetes, heart, location,
            ", ".join(selected_basic + selected_advanced + selected_cancer + selected_heart),
            ", ".join(results), ", ".join(organs), f"{risk:.1f}%"
        ]
        sheet.append_row(data)
        st.success("тЬЕ рдЖрдкрдХрд╛ рдЙрддреНрддрд░ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рд░рд┐рдХреЙрд░реНрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред")

# ---------- FOOTER ----------
st.markdown("---")
st.caption("тЪая╕П рдпрд╣ рдЙрдкрдХрд░рдг рдХреЗрд╡рд▓ рд╢реИрдХреНрд╖рд┐рдХ / рдбреЗрдореЛ рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╣реИред рдпрд╣ рдкреЗрд╢реЗрд╡рд░ рдЪрд┐рдХрд┐рддреНрд╕рд╛ рд╕рд▓рд╛рд╣ рдХрд╛ рд╡рд┐рдХрд▓реНрдк рдирд╣реАрдВ рд╣реИред")
